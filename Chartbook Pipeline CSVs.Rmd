---
title: "Choose Pov Line Trial"
output: html_document
date: "2025-07-24"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Packages and libraries
```{r}
library(tidyverse)
library(pipr)
library(haven)
library(wbpip)
```

# Configurations
```{r}
#General
pov_lines <- c(3.00, 4.20, 8.30) #can change
data_pull <- get_wb(povline = pov_lines)

current_year <- 2025

#Projections (add live github link later)
proj_data <- read_dta("C:/Users/wb646755/Downloads/Country_FGT_2026_2030_20250401_2021_01_02_PROD.dta")

#Class data
class_data <- read_dta("https://raw.githubusercontent.com/GPID-WB/Class/6e6123c1e5f1eea1636dd99f387aa98517d1ac7f/OutputData/CLASS.dta")

#Figure 1a and Figure 1b
fig_1a_start <- 1990 #can change
fig_1a_end <- 2030 #can change

millions3pct_proj <- 256 #called millions3pct2030 in original Flourish

#Figure 2a
fig2a_year_start <- 2010
fig2a_year_end <- 2050
fig_2a_povline <- 3.00


#Figure 2b
fig2b_povline <- 8.30
fig2b_year_start <- 2010
fig2b_year_end <- 2030


```

#Figure 1a: Progress in reducing extreme poverty has come to a halt
graph of three poverty lines over time (over 30+ years with projections to 10 years in the future)
```{r}
fig_1a_pull <- data_pull %>%
  filter(region_name == "World", estimate_type == "actual") %>%
  mutate(millions_poor = pop_in_poverty / 1e6) %>%
  select(year, poverty_line, headcount, millions_poor)

fig_1a_col <- fig_1a_pull %>%
  pivot_wider(names_from = poverty_line,
              values_from = c(headcount, millions_poor),
              names_glue = "{.value}_${sprintf('%.2f', poverty_line)}") %>%
  rename_with(~ str_replace_all(.x, c("headcount_\\$" = "Poverty rate at $",
                                      "millions_poor_\\$" = "Millions of poor at $"))) %>%
  select(1, 2, 5, 3, 6, 4, 7)

#Can change if final file is differently formatted
fig_1a_proj <- proj_data %>%
  filter(year <= fig_1a_end) %>%
  group_by(year, povertyline) %>%
  rename(poverty_line = povertyline) %>%
  summarise(headcount = mean(fgt0, na.rm = TRUE),
            millions_poor = sum(pop, na.rm = TRUE))

fig_1a_proj_col <- fig_1a_proj %>%
  pivot_wider(names_from = poverty_line,
              values_from = c(headcount, millions_poor),
              names_glue = "{.value}_${sprintf('%.2f', poverty_line)}") %>%
  rename_with(~ str_replace_all(.x, c(
    "headcount_\\$(\\d+\\.\\d{2})" = "Poverty rate at $\\1 (forecast)",
    "millions_poor_\\$(\\d+\\.\\d{2})" = "Millions of poor at $\\1 (forecast)")))

fig_1a_combined <- full_join(fig_1a_col, fig_1a_proj_col, by = "year") %>%
  arrange(year) 

fig_1a_data <- fig_1a_combined %>%
  mutate(line3pct = 0) %>% # fix/change later 
  mutate(millions3pct_proj = 256)

write.csv(fig_1a_data, "flourish_fig_1a.csv", row.names = FALSE)
```

## Figure 1b
```{r}
fig_1b_data <- fig_1a_data #same data set (NOTE: slight Flourish title differences?)

write.csv(fig_1b_data, "flourish_fig_1a.csv", row.names = FALSE)
```

## Figure 2a
note: update projection file so data goes to 2050 like in the current graph
```{r}
fig_2a_pull <- get_wb(povline = fig_2a_povline) %>%
  select(region_name, year, headcount) %>%
  filter(region_name == "World") %>%
  filter(year >= fig2a_year_start) %>%
  mutate(
    `Observed` = headcount,
    `Current forecast + historical growth` = NA,
    `2% growth` = NA,
    `2% growth + Gini reduction 1%` = NA,
    `2% growth + Gini reduction 2%` = NA,
    `4% growth` = NA
  ) %>%
  select(year, `Observed`, `Current forecast + historical growth`,
         `2% growth`, `2% growth + Gini reduction 1%`,
         `2% growth + Gini reduction 2%`, `4% growth`) %>%
  complete(year = full_seq(c(min(year), fig2a_year_end), 1))

fig_2a <- fig_2a_pull %>%
  left_join(fig_2a_proj, by = "year")

write.csv(fig_2a, "flourish_fig_2a.csv", row.names = FALSE)

```

## Figure 2b
```{r}
fig_2b_pull <- get_wb(povline = fig_2b_povline) %>%
  select(region_name, year, headcount) %>%
  filter(region_name == "World") %>%
  filter(year >= fig2b_year_start) %>%
  mutate(
    `Observed` = headcount,
    `Current forecast + historical growth` = NA,
    `2% growth` = NA,
    `2% growth + Gini reduction 1%` = NA,
    `2% growth + Gini reduction 2%` = NA,
    `4% growth` = NA
  ) %>%
  select(year, `Observed`, `Current forecast + historical growth`,
         `2% growth`, `2% growth + Gini reduction 1%`,
         `2% growth + Gini reduction 2%`, `4% growth`) %>%
  complete(year = full_seq(c(min(year), fig2b_year_end), 1))

fig_2b <- fig_2b_pull %>%
  left_join(fig_2b_proj, by = "year")
```

## Figure 3a: Poverty is still above prepandemic levels (at $3.00 relative to 2019 levels)
```{r}
fig_3a_povline = 3.00
fig_3a_years <- c(2019, 2020, 2021, 2022, 2023, 2024, 2025)
fig_3a_base_year <- 2019

latest_year <- max(class_data$year_data, na.rm = TRUE)

fig_3_class_data <- class_data %>%
  filter(year_data == latest_year) %>%
  select(economy, code, year_data, incgroup_current)

country_data <- purrr::map_df(
  .x = povertylines,
  .f = pipr::get_stats,
  country = "all",
  year = "all",
  fill_gaps = TRUE
) %>%
  filter(year %in% fig_3a_years)

fig_3a_data <- country_data %>%
  select(region_name, country_name, country_code, year, poverty_line, headcount, pop) %>%
  left_join(
    fig_3_class_data %>%
      select(code, incgroup_current),
    by = c("country_code" = "code")
  )

fig_3a_summary <- fig_3a_data %>%
  group_by(year, incgroup_current) %>%
  summarise(
    weighted_value = sum(headcount * pop, na.rm = TRUE) / sum(pop, na.rm = TRUE),
    .groups = "drop"
  )

fig_3a_wide <- fig_3a_summary %>%
  pivot_wider(names_from = incgroup_current, values_from = weighted_value)

fig_3a_weight <- fig_3a_wide %>%
  mutate(across(-year, ~ .x / .x[year == fig_3a_base_year])) %>%
  mutate(across(-year, ~ round(.x, 2)))  

colnames(fig_3a_weight) <- c(
  "year", 
  "Low-income", 
  "Lower-middle-income", 
  "Lower-middle-income ()", 
  "Upper-middle-income", 
  "Upper-middle-income ()"
)


write_csv(fig_3a_weight, "flourish_fig_3a.csv")
```

## Figure 3b at $8.30 compared to 2019 levels
```{r}
fig_3b_povline <- 8.3

fig_3b_data <- country_data %>%
  filter(poverty_line == fig_3a_povline) %>%
  select(region_name, country_name, country_code, year, poverty_line, headcount, pop) %>%
  left_join(
    fig_3_class_data %>%
      select(code, incgroup_current),
    by = c("country_code" = "code")
  )

fig_3b_weighted <- fig_3b_data %>%
  group_by(year, incgroup_current) %>%
  summarise(
    weighted_value = sum(headcount * pop, na.rm = TRUE) / sum(pop, na.rm = TRUE),
    .groups = "drop"
  ) %>%
  pivot_wider(names_from = incgroup_current, values_from = weighted_value) %>%
  rename_with(~ paste0("Weighted_", .x), -year)

colnames(fig_3b_weighted) <- c(
  "year", 
  "Low-income", 
  "Lower-middle-income", 
  "Lower-middle-income ()", 
  "Upper-middle-income", 
  "Upper-middle-income ()"
)

write_csv(fig_3b_weighted, "flourish_fig_3a.csv")
```


## Figure 4: Stalled Progress on Global Prosperity Gap
note: need updated forcasting data
```{r}
fig_4a_povline <- 3.00
fig_4a_start <- 1990
fig_4a_end <- 2024

region_data <- purrr::map_df(
  .x = fig_4a_povline,
  .f = pipr::get_stats,
  country = "all",
  year = "all",
  fill_gaps = TRUE
) %>%
  filter(region_name %in% c("Sub-Saharan Africa", "Europe & Central Asia",
                            "Other High Income Countries", "Latin America & Caribbean",
                            "South Asia", "East Asia & Pacific",
                            "Middle East & North Africa")) %>%
  select(year, region_name, poverty_gap, pop)

fig_4a <- region_data %>%
  filter(year >= fig_4a_start & year <= fig_4a_end) %>%
  group_by(year) %>%
  summarize(
    `Global Prosperity Gap` = sum(poverty_gap * pop, na.rm = TRUE) / sum(pop, na.rm = TRUE)
  ) %>%
  ungroup() %>%
  mutate(`Global Prosperity Gap (forecast)` = NA) %>%
  arrange(year)

#write_csv(fig_4a, "flourish_fig_4a.csv")
```

## Figure 4b:
```{r}
fig_4b_povline <- 3.00

fig_4b_pull <- purrr::map_df(
  .x = fig_4b_povline,
  .f = pipr::get_stats,
  country = "all",
  year = "all",
  fill_gaps = TRUE
) %>%
  filter(region_name %in% c(
    "Sub-Saharan Africa", "Europe & Central Asia",
    "Other High Income Countries", "Latin America & Caribbean",
    "South Asia", "East Asia & Pacific",
    "Middle East & North Africa"
  )) %>%
  select(region_name, poverty_gap, pop)

fig_4b <- fig_4b_pull %>%
  group_by(region_name) %>%
  summarize(
    `Prosperity Gap share` = sum(poverty_gap * pop, na.rm = TRUE) / sum(fig_4b_pull$poverty_gap * fig_4b_pull$pop, na.rm = TRUE) * 100,
    `Population share` = sum(pop, na.rm = TRUE) / sum(fig_4b_pull$pop, na.rm = TRUE) * 100
  ) %>%
  ungroup() %>%
  mutate(region_name = recode(region_name,
                              "Other High Income Countries" = "Rest of the world",
                              "Europe & Central Asia" = "Europe and Central Asia",
                              "East Asia & Pacific" = "East Asia and Pacific",
                              "Latin America & Caribbean" = "Latin America and the Caribbean",
                              "Middle East & North Africa" = "Middle East and North Africa"))

fig_4b_formatted <- fig_4b %>%
  pivot_longer(cols = c(`Prosperity Gap share`, `Population share`),
               names_to = "Country",
               values_to = "Value") %>%
  pivot_wider(names_from = region_name, values_from = Value)

fig_4b_formatted <- fig_4b_formatted %>%
  select(
    Country,
    `Sub-Saharan Africa`,
    `South Asia`,
    `East Asia and Pacific`,
    `Latin America and the Caribbean`,
    `Middle East and North Africa`,
    `Rest of the world`,
    `Europe and Central Asia`
  )

write_csv(fig_4b_pull, "flourish_fig_4b.csv")
```
## Figure 5: Limited Gains

```{r}
## NA data from other sources

```

## Map 1:
```{r}
library(WDI)
library(dplyr)

gini_data <- WDI(indicator = "SI.POV.GINI", extra = TRUE)

gini_latest <- gini_data %>%
  group_by(iso2c) %>%
  filter(!is.na(SI.POV.GINI)) %>%
  slice_max(year, n = 1) %>%
  ungroup() %>%
  select(iso3c, country, year, SI.POV.GINI, region) %>%
  rename(
    country_code = iso3c,
    `Country Name` = country,
    `Gini index` = SI.POV.GINI,
    Region = region,
    `Survey year` = year
  ) %>%
  left_join(country_data %>% select(country_code, welfare_type), by = "country_code") %>%
  rename(`Welfare type` = welfare_type) %>%
  distinct(country_code, .keep_all = TRUE) %>%
  select(country_code, `Country Name`, `Survey year`, `Gini index`, Region, `Welfare type`)


flourish_countries <- read_csv("https://raw.githubusercontent.com/GPID-WB/pip-chartbook/0c4e7507c77f10b977bacb205a910b2425eb5d12/Chartbook_Data_Files/flourish_country_names.csv") %>%
  distinct(country_code, .keep_all = TRUE)

map_1_data_comb <- gini_latest %>%
  left_join(flourish_countries, by = "country_code")

map_1_data_full <- map_1_data_comb %>%
  mutate(
    Classification = case_when(
      `Gini index` < 30 ~ "Low inequality",
      `Gini index` >= 30 & `Gini index` < 40 ~ "Moderate inequality",
      `Gini index` >= 40 ~ "High inequality",
      TRUE ~ NA_character_)) %>%
  select(
    country_code,
    `Country Name`,
    country_name_flourish,
    Region,
    `Survey year`,
    `Gini index`,
    `Welfare type`,
    Classification
  )


write_csv(map_1_data_full, "flourish_map_1.csv")

```

## Figure 6a: Poorer and conflict...by income group

```{r}
fig_6_data <- gini_data %>%
  filter(!is.na(SI.POV.GINI)) %>%
  select(iso3c, year, SI.POV.GINI) %>%
  rename(
    country_code = iso3c,
    `Survey year` = year,
    `Gini index` = SI.POV.GINI
  ) %>%
  mutate(
    Classification = case_when(
      `Gini index` < 30 ~ "Low inequality",
      `Gini index` >= 30 & `Gini index` < 40 ~ "Moderate inequality",
      `Gini index` >= 40 ~ "High inequality"
    )
  )

fig_6a <- class_data %>%
  rename(country_code = code) %>%
  left_join(fig_6_data, by = c("country_code", "year_data" = "Survey year")) %>%
  filter(!is.na(`Gini index`)) %>%
  group_by(country_code) %>%
  slice_max(year_data, n = 1) %>%
  ungroup() %>%
  select(country_code, year_data, region, incgroup_current, `Gini index`, Classification)

fig_6a_summary <- fig_6a %>%
  group_by(incgroup_current, Classification) %>%
  summarise(count = n(), .groups = "drop") %>%
  group_by(incgroup_current) %>%
  mutate(percent = 100 * count / sum(count)) %>%
  select(incgroup_current, Classification, percent) %>%
  pivot_wider(
    names_from = Classification,
    values_from = percent,
    values_fill = 0
  ) %>%
  rename(Group = incgroup_current)

```


## Figure 6b:
```{r}
fig_6b <- class_data %>%
  rename(country_code = code) %>%
  left_join(fig_6_data, by = c("country_code", "year_data" = "Survey year")) %>%
  filter(!is.na(`Gini index`)) %>%
  group_by(country_code) %>%
  slice_max(year_data, n = 1) %>%
  ungroup() %>%
  select(country_code, year_data, region, fcv_current, `Gini index`, Classification)

fig_6b_summary <- fig_6b %>%
  group_by(fcv_current, Classification) %>%
  summarise(count = n(), .groups = "drop") %>%
  group_by(fcv_current) %>%
  mutate(percent = 100 * count / sum(count)) %>%
  select(fcv_current, Classification, percent) %>%
  pivot_wider(
    names_from = Classification,
    values_from = percent,
    values_fill = 0
  ) %>%
  rename(Group = fcv_current) %>%
  mutate(Group = ifelse(Group == "No", "Non-FCS", "FCS"))

```



